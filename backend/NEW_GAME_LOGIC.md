# Новая логика игры

## Обновленная механика

### Урон за попытку
- **Фиксированный урон**: 20 жизней за каждую попытку
- **Всего попыток**: 5
- **Всего жизней**: 100
- **Результат**: На 5-й попытке игрок побеждает (0 попыток + 0 жизней)

### Последовательность игры
1. **Попытка 1**: 100 → 80 жизней (4 попытки осталось)
2. **Попытка 2**: 80 → 60 жизней (3 попытки осталось)
3. **Попытка 3**: 60 → 40 жизней (2 попытки осталось)
4. **Попытка 4**: 40 → 20 жизней (1 попытка осталось)
5. **Попытка 5**: 20 → 0 жизней (0 попыток осталось) = **ПОБЕДА!**

## Система призов

### Получение приза
1. Игрок побеждает (использует все 5 попыток и тратит все 100 жизней)
2. В комментарии появляется сообщение с инструкцией написать "Приз" в личные сообщения
3. Игрок пишет сообщение "Приз" в личные сообщения сообществу
4. Бот проверяет, что игрок действительно победил
5. Бот отправляет ответ "купон"

### Проверка права на приз
```sql
SELECT * FROM vk_players 
WHERE vk_user_id = ? AND attempts_left <= 0 AND lives_count <= 0
```

### Обработка сообщений
- Webhook получает событие `message_new`
- Проверяется текст сообщения на точное совпадение "приз" (регистронезависимо)
- Если совпадает - вызывается `handlePrizeRequest()`

## API эндпоинты

### Тестирование игровой системы
```
POST /api/game/test
```
Тестирует новую логику с фиксированным уроном 20 жизней за попытку.

### Тестирование системы призов
```
POST /api/prize/test
Body: { "vk_user_id": 123456789 }
```
Тестирует обработку запроса приза для указанного пользователя.

## Изменения в коде

### database.js
- `calculateRandomDamage()` → `calculateDamage()` (возвращает всегда 20)

### server.js
- Обновлен импорт функции урона
- Добавлена функция `handlePrizeRequest()`
- Добавлена функция `sendMessage()`
- Обновлена логика в `handleNewMessage()` для обработки слова "Приз"
- Обновлено сообщение о победе с инструкциями по получению приза
- Добавлен API эндпоинт `/api/prize/test`

### test-game-system.js
- Обновлен для тестирования новой логики
- Симуляция ровно 5 попыток с фиксированным уроном
